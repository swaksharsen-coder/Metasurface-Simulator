<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metasurface Far-Field Simulator (with Firebase)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    h1, h2, h3 {
      margin-top: 12px;
      margin-bottom: 6px;
    }
    .section {
      background: #ffffff;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      min-height: 80px;
      font-family: Consolas, monospace;
      font-size: 12px;
      white-space: pre;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    button {
      margin: 4px 4px 4px 0;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #999;
      background: #eee;
      cursor: pointer;
    }
    button:hover {
      background: #ddd;
    }
    #heatmap {
      border: 1px solid #444;
      margin-top: 8px;
    }
    table {
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 2px 4px;
      font-size: 11px;
      text-align: right;
    }
    .status {
      font-size: 12px;
      color: #333;
      margin-top: 4px;
    }
    .small-input {
      width: 80px;
    }
    .row-flex {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 260px;
    }
    select {
      padding: 3px 6px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h1>Metasurface Far-Field Simulator (10×10, with Firebase)</h1>

  <!-- ===================== LIBRARY SECTION ===================== -->
  <div class="section">
    <h2>1. 400 nm Library (24×24) — φx, φy, Tx, Ty</h2>
    <p>Paste your <b>24×24</b> matrices (24 lines, each line 24 numbers separated by spaces) for the unit-cell library.</p>

    <div class="row-flex">
      <div class="col">
        <label for="libPhiX">φ<sub>x</sub> (Ex phase, rad, 24×24)</label>
        <textarea id="libPhiX" placeholder="row1: 24 numbers&#10;row2: 24 numbers&#10;..."></textarea>
      </div>
      <div class="col">
        <label for="libPhiY">φ<sub>y</sub> (Ey phase, rad, 24×24)</label>
        <textarea id="libPhiY"></textarea>
      </div>
    </div>

    <div class="row-flex">
      <div class="col">
        <label for="libTx">T<sub>x</sub> (Ex amplitude, 0–1, 24×24)</label>
        <textarea id="libTx"></textarea>
      </div>
      <div class="col">
        <label for="libTy">T<sub>y</sub> (Ey amplitude, 0–1, 24×24)</label>
        <textarea id="libTy"></textarea>
      </div>
    </div>

    <button id="btnSaveLibrary">Save Library to Firebase</button>
    <button id="btnLoadLibrary">Load Library from Firebase</button>
    <div id="libraryStatus" class="status"></div>
  </div>

  <!-- ===================== DESIGN SECTION ===================== -->
  <div class="section">
    <h2>2. Metasurface Phase Design (10×10) for 6 Polarizations</h2>
    <p>
      For testing, paste <b>10×10 phase maps</b> (radians) for each polarization channel.
      Each textarea expects 10 lines, each with 10 numbers.
      The simulator will use the chosen input polarization to compute the far field.
    </p>

    <div class="row-flex">
      <div class="col">
        <label for="phiExMap">φ<sub>Ex</sub> (10×10)</label>
        <textarea id="phiExMap" placeholder="Ex phase map"></textarea>
      </div>
      <div class="col">
        <label for="phiEyMap">φ<sub>Ey</sub> (10×10)</label>
        <textarea id="phiEyMap" placeholder="Ey phase map"></textarea>
      </div>
    </div>

    <div class="row-flex">
      <div class="col">
        <label for="phiP45Map">φ<sub>+45°</sub> (10×10)</label>
        <textarea id="phiP45Map" placeholder="+45 phase map"></textarea>
      </div>
      <div class="col">
        <label for="phiM45Map">φ<sub>−45°</sub> (10×10)</label>
        <textarea id="phiM45Map" placeholder="-45 phase map"></textarea>
      </div>
    </div>

    <div class="row-flex">
      <div class="col">
        <label for="phiRCPMap">φ<sub>RCP</sub> (10×10)</label>
        <textarea id="phiRCPMap" placeholder="RCP phase map"></textarea>
      </div>
      <div class="col">
        <label for="phiLCPMap">φ<sub>LCP</sub> (10×10)</label>
        <textarea id="phiLCPMap" placeholder="LCP phase map"></textarea>
      </div>
    </div>

    <button id="btnSaveDesign">Save Design to Firebase</button>
    <button id="btnLoadDesign">Load Design from Firebase</button>
    <div id="designStatus" class="status"></div>
  </div>

  <!-- ===================== SIMULATION SECTION ===================== -->
  <div class="section">
    <h2>3. Simulation Settings & Run</h2>

    <label>
      Input polarization:
      <select id="inputPol">
        <option value="Ex">Ex</option>
        <option value="Ey">Ey</option>
        <option value="P45">+45°</option>
        <option value="M45">−45°</option>
        <option value="RCP">RCP</option>
        <option value="LCP">LCP</option>
      </select>
    </label>

    <label>
      Max diffraction order |m|, |n| (integer, ≤ 8 recommended):
      <input id="maxOrder" type="number" value="8" class="small-input">
    </label>

    <button id="btnRun">Run Simulation</button>
    <div id="simStatus" class="status"></div>
  </div>

  <!-- ===================== RESULTS SECTION ===================== -->
  <div class="section">
    <h2>4. Far-Field Results</h2>
    <p>Intensity is normalized so that the maximum over all (m,n) is 1. (0,0) order and a 2D heatmap are shown.</p>

    <div id="onAxisInfo" class="status"></div>
    <canvas id="heatmap" width="400" height="400"></canvas>
    <div id="intensityTableContainer"></div>
  </div>

  <!-- ===================== SCRIPTS ===================== -->
  <!-- Firebase (v11) - use your own config below -->
  <script type="module">
    /************* 1. Firebase Setup *************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // TODO: REPLACE with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAGH2mKUzliyYytlxnqeJs_hPget2Uiik0",
  authDomain: "metasurface-9d919.firebaseapp.com",
  projectId: "metasurface-9d919",
  storageBucket: "metasurface-9d919.firebasestorage.app",
  messagingSenderId: "954226935548",
  appId: "1:954226935548:web:9ef1d9f09810fc3ae8f979",
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const libDocRef    = doc(db, "metasurface", "library_400nm");
    const designDocRef = doc(db, "metasurface", "design_10x10");

    /************* 2. Helper: Parse / Stringify Matrices *************/
    function parseMatrix(text, expectedRows, expectedCols) {
      const rows = text.trim().split(/\r?\n/).filter(r => r.trim().length > 0);
      if (rows.length !== expectedRows) {
        throw new Error(`Expected ${expectedRows} rows, got ${rows.length}`);
      }
      const mat = [];
      for (let i = 0; i < expectedRows; i++) {
        const parts = rows[i].trim().split(/[\s,]+/).filter(p => p.length > 0);
        if (parts.length !== expectedCols) {
          throw new Error(`Row ${i+1}: expected ${expectedCols} columns, got ${parts.length}`);
        }
        mat[i] = parts.map(Number);
      }
      return mat;
    }

    function matrixToText(mat) {
      return mat.map(row => row.join(" ")).join("\n");
    }

    /************* 3. Get / Set UI for Library & Design *************/
    function getLibraryFromUI() {
      const phiXText = document.getElementById("libPhiX").value;
      const phiYText = document.getElementById("libPhiY").value;
      const txText   = document.getElementById("libTx").value;
      const tyText   = document.getElementById("libTy").value;

      return {
        phiX: phiXText,
        phiY: phiYText,
        Tx:   txText,
        Ty:   tyText
      };
    }

    function setLibraryToUI(libObj) {
      if (!libObj) return;
      document.getElementById("libPhiX").value = libObj.phiX || "";
      document.getElementById("libPhiY").value = libObj.phiY || "";
      document.getElementById("libTx").value   = libObj.Tx   || "";
      document.getElementById("libTy").value   = libObj.Ty   || "";
    }

    function getDesignFromUI() {
      return {
        phiEx:  document.getElementById("phiExMap").value,
        phiEy:  document.getElementById("phiEyMap").value,
        phiP45: document.getElementById("phiP45Map").value,
        phiM45: document.getElementById("phiM45Map").value,
        phiRCP: document.getElementById("phiRCPMap").value,
        phiLCP: document.getElementById("phiLCPMap").value
      };
    }

    function setDesignToUI(desObj) {
      if (!desObj) return;
      document.getElementById("phiExMap").value  = desObj.phiEx  || "";
      document.getElementById("phiEyMap").value  = desObj.phiEy  || "";
      document.getElementById("phiP45Map").value = desObj.phiP45 || "";
      document.getElementById("phiM45Map").value = desObj.phiM45 || "";
      document.getElementById("phiRCPMap").value = desObj.phiRCP || "";
      document.getElementById("phiLCPMap").value = desObj.phiLCP || "";
    }

    /************* 4. Firebase Save / Load *************/
    async function saveLibraryToFirebase() {
      const statusEl = document.getElementById("libraryStatus");
      statusEl.textContent = "Saving library to Firebase...";
      try {
        const lib = getLibraryFromUI();
        await setDoc(libDocRef, lib);
        statusEl.textContent = "Library saved successfully.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error saving library: " + err.message;
      }
    }

    async function loadLibraryFromFirebase() {
      const statusEl = document.getElementById("libraryStatus");
      statusEl.textContent = "Loading library from Firebase...";
      try {
        const snap = await getDoc(libDocRef);
        if (!snap.exists()) {
          statusEl.textContent = "No library found in Firebase (metasurface/library_400nm).";
          return;
        }
        const data = snap.data();
        setLibraryToUI(data);
        statusEl.textContent = "Library loaded.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading library: " + err.message;
      }
    }

    async function saveDesignToFirebase() {
      const statusEl = document.getElementById("designStatus");
      statusEl.textContent = "Saving design to Firebase...";
      try {
        const design = getDesignFromUI();
        await setDoc(designDocRef, design);
        statusEl.textContent = "Design saved successfully.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error saving design: " + err.message;
      }
    }

    async function loadDesignFromFirebase() {
      const statusEl = document.getElementById("designStatus");
      statusEl.textContent = "Loading design from Firebase...";
      try {
        const snap = await getDoc(designDocRef);
        if (!snap.exists()) {
          statusEl.textContent = "No design found in Firebase (metasurface/design_10x10).";
          return;
        }
        const data = snap.data();
        setDesignToUI(data);
        statusEl.textContent = "Design loaded.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading design: " + err.message;
      }
    }

    document.getElementById("btnSaveLibrary").addEventListener("click", saveLibraryToFirebase);
    document.getElementById("btnLoadLibrary").addEventListener("click", loadLibraryFromFirebase);
    document.getElementById("btnSaveDesign").addEventListener("click", saveDesignToFirebase);
    document.getElementById("btnLoadDesign").addEventListener("click", loadDesignFromFirebase);

    /************* 5. Far-Field Simulation (10×10, one polarization at a time) *************/
    function getPhaseMapForPol(pol) {
      let text = "";
      switch (pol) {
        case "Ex":  text = document.getElementById("phiExMap").value;  break;
        case "Ey":  text = document.getElementById("phiEyMap").value;  break;
        case "P45": text = document.getElementById("phiP45Map").value; break;
        case "M45": text = document.getElementById("phiM45Map").value; break;
        case "RCP": text = document.getElementById("phiRCPMap").value; break;
        case "LCP": text = document.getElementById("phiLCPMap").value; break;
      }
      if (!text.trim()) {
        throw new Error(`Phase map for ${pol} is empty.`);
      }
      return parseMatrix(text, 10, 10);  // 10×10
    }

    function computeFarField(phaseMap, maxOrder) {
      const Nx = 10;
      const Ny = 10;

      const size = 2 * maxOrder + 1;
      const intensities = [];
      for (let i = 0; i < size; i++) {
        intensities[i] = new Array(size).fill(0);
      }

      let maxI = 0;
      let I00 = 0;

      for (let mi = -maxOrder; mi <= maxOrder; mi++) {
        for (let ni = -maxOrder; ni <= maxOrder; ni++) {
          let Ex_real = 0, Ex_imag = 0;
          for (let px = 0; px < Nx; px++) {
            for (let py = 0; py < Ny; py++) {
              const phi = phaseMap[px][py]; // radians
              const arg = phi - 2 * Math.PI * (mi * px / Nx + ni * py / Ny);
              Ex_real += Math.cos(arg);
              Ex_imag += Math.sin(arg);
            }
          }
          const intensity = Ex_real * Ex_real + Ex_imag * Ex_imag;
          const ii = mi + maxOrder;
          const jj = ni + maxOrder;
          intensities[ii][jj] = intensity;
          if (intensity > maxI) maxI = intensity;
          if (mi === 0 && ni === 0) I00 = intensity;
        }
      }

      if (maxI > 0) {
        for (let i = 0; i < size; i++) {
          for (let j = 0; j < size; j++) {
            intensities[i][j] /= maxI;
          }
        }
        I00 /= maxI;
      }

      return { intensities, I00, maxI };
    }

    function drawHeatmap(intensities, canvas, maxOrder) {
      const ctx = canvas.getContext("2d");
      const size = intensities.length;
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const cellW = w / size;
      const cellH = h / size;

      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size; j++) {
          const val = intensities[i][j];
          const c = Math.max(0, Math.min(1, val));
          const r = Math.floor(255 * c);
          const g = 0;
          const b = Math.floor(255 * (1 - c));
          ctx.fillStyle = `rgb(${r},${g},${b})`;
          ctx.fillRect(j * cellW, i * cellH, cellW, cellH);
        }
      }

      // Draw axes lines at m=0 and n=0
      ctx.strokeStyle = "white";
      ctx.lineWidth = 1;
      const zeroIndex = maxOrder + 0.5;
      ctx.beginPath();
      ctx.moveTo(zeroIndex * cellW, 0);
      ctx.lineTo(zeroIndex * cellW, h);
      ctx.moveTo(0, zeroIndex * cellH);
      ctx.lineTo(w, zeroIndex * cellH);
      ctx.stroke();
    }

    function createIntensityTable(intensities, maxOrder) {
      const size = intensities.length;
      let html = "<table><thead><tr><th>m \\ n</th>";
      for (let n = -maxOrder; n <= maxOrder; n++) {
        html += `<th>${n}</th>`;
      }
      html += "</tr></thead><tbody>";

      for (let m = -maxOrder; m <= maxOrder; m++) {
        html += `<tr><th>${m}</th>`;
        for (let n = -maxOrder; n <= maxOrder; n++) {
          const ii = m + maxOrder;
          const jj = n + maxOrder;
          const val = intensities[ii][jj];
          html += `<td>${val.toFixed(3)}</td>`;
        }
        html += "</tr>";
      }
      html += "</tbody></table>";
      return html;
    }

    function runSimulation() {
      const simStatus = document.getElementById("simStatus");
      simStatus.textContent = "";
      document.getElementById("onAxisInfo").textContent = "";
      document.getElementById("intensityTableContainer").innerHTML = "";

      const canvas = document.getElementById("heatmap");
      const pol = document.getElementById("inputPol").value;
      const maxOrder = parseInt(document.getElementById("maxOrder").value, 10);

      if (isNaN(maxOrder) || maxOrder < 0 || maxOrder > 12) {
        simStatus.textContent = "Please choose maxOrder between 0 and 12.";
        return;
      }

      try {
        const phaseMap = getPhaseMapForPol(pol);
        const { intensities, I00 } = computeFarField(phaseMap, maxOrder);

        drawHeatmap(intensities, canvas, maxOrder);

        const onAxisEl = document.getElementById("onAxisInfo");
        onAxisEl.textContent = `(0,0) order normalized intensity: ${I00.toFixed(3)}`;

        const tableHTML = createIntensityTable(intensities, maxOrder);
        document.getElementById("intensityTableContainer").innerHTML = tableHTML;

        simStatus.textContent = "Simulation complete.";
      } catch (err) {
        console.error(err);
        simStatus.textContent = "Error in simulation: " + err.message;
      }
    }

    document.getElementById("btnRun").addEventListener("click", runSimulation);
  </script>
</body>
</html>
